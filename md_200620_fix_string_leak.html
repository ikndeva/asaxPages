<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>asax02.neo: 200620 Fixing String Object Leak Problem</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="myextrastysheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">asax02.neo
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_200620_fix_string_leak.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">200620 Fixing String Object Leak Problem </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>200620FixStringLeak.md</p>
<p>200620, by <a href="#" onclick="location.href='mai'+'lto:'+'ari'+'m@'+'ist'+'.h'+'oku'+'da'+'i.a'+'c.'+'jp'; return false;">arim@<span style="display: none;">.nosp@m.</span>ist.<span style="display: none;">.nosp@m.</span>hokud<span style="display: none;">.nosp@m.</span>ai.a<span style="display: none;">.nosp@m.</span>c.jp</a></p>
<h1>現状分析</h1>
<h2>machine</h2>
<p>クラス<code>OVMachine</code>は、<code>StackBase&lt;String&gt;</code>型のスタック<code>strStack</code>をもつ。</p>
<div class="fragment"><div class="line">public class OVMachine {</div>
<div class="line">  StackBase&lt;String&gt; strStack = null; </div>
<div class="line">  this.strStack = new StackBase&lt;String&gt;(null, initCapacity); </div>
<div class="line"> </div>
<div class="line">  ///@brief 型xtのスタックを返す.</div>
<div class="line">  public &lt;T&gt; StackBase&lt;T&gt; getStack(XType xt) {</div>
<div class="line">    switch(xt) {</div>
<div class="line">    case String: return (StackBase&lt;T&gt;)this.strStack;</div>
<div class="line">    default:</div>
<div class="line">        Util.errorExit(&quot;no such a type!:&quot;+xt); return null;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">} </div>
</div><!-- fragment --><h2>スタック</h2>
<p>コマンドは、次のスタックに対して、操作を行う。</p>
<h2>OVMMachine</h2>
<ul>
<li><code>OVMachine</code>のもつ<code>StackBase&lt;String&gt;</code>型のスタック<code>strStack</code>.</li>
</ul>
<div class="fragment"><div class="line">StackBase&lt;String&gt; SO = OS.getStack(this.xt); </div>
</div><!-- fragment --><h2>FrameStackUni</h2>
<ul>
<li><code>FrameStackUni</code>のもつ<code>AutoStack&lt;StringAdder&gt;</code>型のスタック<code>SS</code>.</li>
</ul>
<div class="fragment"><div class="line">AutoStack&lt;StringAdder&gt; SS = this.SS; </div>
<div class="line">StringAdder elem = SS.get(fetchRecord(fp, vid).val);</div>
</div><!-- fragment --><h2>コマンド</h2>
<div class="fragment"><div class="line">//note: OS.getStack(this.xt)はStackBase&lt;String&gt;型。</div>
<div class="line"> </div>
<div class="line">  //public static class CmdTypeConst&lt;T&gt; extends Command { </div>
<div class="line">    T tval; //note: T := String</div>
<div class="line">    XType xt; </div>
<div class="line">    </div>
<div class="line">    /// スタックトップに整数定数値をおく．</div>
<div class="line">    public void exec(Context env, Call call, OVMachine OS) {</div>
<div class="line">      OS.getStack(this.xt).push(this.tval);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">  ///@brief スタックトップに文字列変数値を取り出す．</div>
<div class="line">  public static class CmdStrLoad extends CommandStorage {</div>
<div class="line"> </div>
<div class="line">    /// スタックトップに文字列変数値をおく．</div>
<div class="line">    public void exec(Context env, Call call, OVMachine OS) {</div>
<div class="line">        String sval = env.scope().getElemString(call.fp, this.var).get();</div>
<div class="line">        OS.getStackString().push(sval);</div>
<div class="line">    }</div>
<div class="line">  }//class CmdStrLoad</div>
</div><!-- fragment --><h1>改良の方針</h1>
<h2>FrameStackUni側</h2>
<p>フレームスタック<code>FrameStackUni</code>はさわらない。 フレームスタックは、コマンドからアクセスリクエストを受けると、<code>StringAdder elem = env.scope().getElemString(fp, ref)</code>により、<code>StringAdder elem</code>オブジェクトを取り出す。</p>
<p>現状では、<code>String sval = elem.toString()</code>によって、毎回、一時的な<code>String</code>オブジェクトを生成して 、OVMachineにおけるコマンド側に渡す。この一時的な<code>String</code>オブジェクトが、使用後も回収されていないのが、メモリリークの原因である。</p>
<p>一時オブジェクトが、プログラムのどこかに保存されているはずだが、詳細は不明である。</p>
<h2>OVMachine側</h2>
<p><code>StackBase&lt;String&gt; strStack</code></p>
<h1>メモリリークの原因</h1>
<p>なんとなくわかった。実行環境の問題ではなく、最近変更したコンパイラの問題。</p>
<p>結果の出力時にヒープ領域の不足で停止するが、これは、データベースのクエリの出力全てを連結した巨大な文字列オブジェクトを生成していたためであろう。</p>
<p>ヒープ領域における文字列オブジェクトのメモリが足りなくなるのは、当然である。</p>
<h1>EOF</h1>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Jun 24 2020 23:20:08 for asax02.neo by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
