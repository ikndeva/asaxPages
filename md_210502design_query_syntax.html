<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>asax02.neo: 210502 Design of Query Syntax</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="myextrastysheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">asax02.neo
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_210502design_query_syntax.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">210502 Design of Query Syntax </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>210502design_query_syntax.md, <a href="#" onclick="location.href='mai'+'lto:'+'ari'+'m@'+'ist'+'.h'+'oku'+'da'+'i.a'+'c.'+'jp'; return false;">arim@<span style="display: none;">.nosp@m.</span>ist.<span style="display: none;">.nosp@m.</span>hokud<span style="display: none;">.nosp@m.</span>ai.a<span style="display: none;">.nosp@m.</span>c.jp</a></p>
<hr  />
 <h1>パスパターンの構文</h1>
<p>論点：クエリの記述に引用符&lsquo;",&rsquo;`が多用されている．</p>
<ul>
<li>使用箇所：クエリの出力項の囲み記号</li>
<li>使用箇所：文字列照合のパターンの囲み記号</li>
<li>短所：コマンドにクエリを引用符を用いて渡すときに，クエリ中の引用符が衝突する．</li>
</ul>
<p>論点：パス表現の記述にスラッシュ<code>/</code>が使用されている．</p>
<ul>
<li>パスの区切り記号．</li>
<li>利点：パス表現の標準であるXPathで使用されている．</li>
<li>欠点：パターン・正規表現の囲み記号にスラッシュを使えない．</li>
</ul>
<p>改良案</p>
<ul>
<li>**スラッシュ**を，文字列式，パターン，正規表現，出力項の囲み記号に使えるように拡張する．スクリプト言語の慣習．パターン照合系はスラッシュ．</li>
<li>**引用符**も，引き続き，文字列式の囲み記号に使えるように保持する．これは，シェルと併合しないときには，プログラム言語の長い慣習に合っており，便利．</li>
<li>**ドット**を，パス表現のラベルの区切り記号に用いる．これは，XMLでなく，CSSの習慣に合わせる．将来的には，辞書（連想配列）や，オブジェクトのフィールドアクセス演算子にも共用する．</li>
</ul>
<hr  />
 <h1>ブロックのための記法</h1>
<p>ブロックと変数束縛に関する記法の導入が必要だろう． 基本構文は，次の通り．</p>
<p>引数なしブロック</p>
<div class="fragment"><div class="line">do ... end</div>
<div class="line">{ ... }</div>
</div><!-- fragment --><p>引数付きブロック</p>
<div class="fragment"><div class="line">do |...| ... end</div>
<div class="line">{|...| ... }</div>
</div><!-- fragment --><p>ブロック内の変数宣言．ブロックの内側で局所的な変数を意味する． </p><div class="fragment"><div class="line">var name {&#39;:&#39; type {&#39;=&#39; value}  }   </div>
</div><!-- fragment --><p>この局所変数宣言に対して，次の処理を行う．</p>
<ul>
<li>静的: 前処理では，nameに対して一意な変数IDが生成され，全体辞書に登録される．さらにブロック定義（関数定義）において，変数IDと型の対（変数キー＝参照）が，ヘッダーの変数リストに追加される．局所変数は，引数と，そうでない局所変数に分類されて追加される．</li>
<li>動的: ブロックに対応するフレームの生成時に，ブロック定義のヘッダーの変数リストに含まれる変数キー全てに対して，変数IDと型に対応するレコードがフレームに追加される．</li>
</ul>
<p>大域的変数の宣言．これは，ブロックの外側にある変数を意味する．これは，宣言ではなく，人間向けのコメント（ディレクティブ）であり，ブロックには記述されない． </p><div class="fragment"><div class="line">global name {&#39;:&#39; type {&#39;=&#39; value}  }   </div>
</div><!-- fragment --><ul>
<li>静的： 変数キーで検索し，変数の先祖チェインにキーが見つからなければ，エラーにするか，とりあえずトップレベルの環境に変数宣言を挿入する．</li>
<li>動的： 何もしない．</li>
</ul>
<hr  />
 <h1>ブロックの実装</h1>
<p>ブロック構造体<code>blockdef</code>は，XMに関数フレームを生成させるための情報を保持する． ブロック構造体は，次のフィールドをもつ：</p>
<div class="fragment"><div class="line">def block do </div>
<div class="line">    varlist: List of VarKey</div>
<div class="line">    nrets: Int #number of variables for return value pointers</div>
<div class="line">    nargs: Int #number of variables for input argument values</div>
<div class="line">    nvars: Int #number of variables for local variables</div>
<div class="line">    code: List of OVInst</div>
<div class="line">end </div>
</div><!-- fragment --><p>実行系において，一つのブロック構造体から，個数に制限なくそのブロックの実体（インスタンス）を生成できる．</p>
<p>ブロックの実体は，ひと組みのデータを格納するための変数レコードの集合であるフレームであり，フレームは，自分の長さ（＝それを構成するレコード数）自身をデータの一つとして保持しており，フレーム自身は，フレームポインタと呼ばれる，その開始番地で表される．</p>
<p>現在のプロセス環境を表すフレームポインタfpと，変数キーvarが与えられると，その変数の実体であるレコードが一意に決まる．そのレコード r を（**変数レコード**）と呼び，レコードの**番地** p を，その変数の参照（**変数参照**）と呼ぶ．</p>
<p>フレームスタックをレコードの配列<code>VarRecord FS[0..MaxFS-1]</code>と考えると，<code>FS[p] = r</code>である．</p>
<p>XScanでは，ブロックの実体を用いて，関数呼び出しとプロセス呼び出しを実現する．さらに，関数閉包とオブジェクトを実現できる．</p>
<h2>変数機構</h2>
<p>変数の「名前」は，次の構造体で表される**変数キー**（VarKey）が保持する．これは，変数IDと型の対である</p>
<div class="fragment"><div class="line">def VarKey do </div>
<div class="line">    Int   vid</div>
<div class="line">    XType typ</div>
<div class="line">end </div>
</div><!-- fragment --><p>変数の「実体」は，フレームスタック上の**レコード**（VarRecord）である．これは，変数IDと型の対に加えて，変数が実際に保持する値をもつ三つ組（triple）である．</p>
<div class="fragment"><div class="line">def VarRecord do</div>
<div class="line">    VarKey var  #変数キー</div>
<div class="line">    Object val  #値のオブジェクト</div>
<div class="line">end</div>
</div><!-- fragment --><p>フレームスタックは，スタック的にレベルで管理される変数レコードの配列であり，各種の操作関数をもつ．</p>
<div class="fragment"><div class="line">def FrameStack do </div>
<div class="line">    Int MaxFS #保持するレコード数</div>
<div class="line">    Int top   #最上位のレコードの添字．関数_pushと_popで管理される．</div>
<div class="line">    List&lt;VarRecord&gt; RS[0..MaxFS-1] #レコードの配列</div>
<div class="line">    #各種の関数</div>
<div class="line">    int _top()      #頂上の番地を返す．</div>
<div class="line">    Int _push()     #頂上に初期化された新しいレコードを挿入する</div>
<div class="line">    VarRecord _pop()#頂上のレコードを削除する</div>
<div class="line">    VarRecord _get(Int p)   #番地pのレコードを返す</div>
<div class="line">    ...</div>
<div class="line">end </div>
</div><!-- fragment --><h2>フレームスタックとレコードの基本操作関数</h2>
<div class="fragment"><div class="line">#内部関数：新しいレコードを挿入する</div>
<div class="line">def Int FS._insertRecord(VarKey var, Object val) do </div>
<div class="line">    Int p = FS.push_()</div>
<div class="line">    VarRecord vr = FS.get(fp)</div>
<div class="line">    vr.var = var    #変数キー</div>
<div class="line">    vr.val  = val   #変数の値</div>
<div class="line">    return p</div>
<div class="line">end </div>
<div class="line"> </div>
<div class="line">#変数参照から変数レコードを得る</div>
<div class="line">def VarRecord FS.get(p) do </div>
<div class="line">    VarRecord r = RS.get(p)</div>
<div class="line">    assert r != null </div>
<div class="line">    return r </div>
<div class="line">end</div>
<div class="line"> </div>
<div class="line">#変数参照から型検査を通した整数値を得る</div>
<div class="line">def Int FS.getIntVal(p) do </div>
<div class="line">    VarRecord r = FS.get(p)</div>
<div class="line">    if (r.val instanceof Int val_) </div>
<div class="line">        return val_</div>
<div class="line">    else </div>
<div class="line">        panic(&quot;fp_par_ must has type Int! &quot;+type(fp_par))</div>
<div class="line">end</div>
</div><!-- fragment --><h2>フレームの操作関数</h2>
<div class="fragment"><div class="line">#フレーム定義のためのパラメータ</div>
<div class="line">int _off = 0</div>
<div class="line">Int FS.OFFSET_FPPAR  = _off++   #0</div>
<div class="line">Int FS.OFFSET_FSIZE  = _off++   #1</div>
<div class="line">Int FS.LENGTH_HEADER = _off     #2</div>
<div class="line"> </div>
<div class="line">#新しいフレームを生成する</div>
<div class="line">def Int FS._alloc_frame(Int fp_par) do</div>
<div class="line">    Int fp = _insertRecord(new VarKey(XType.fptr, XM.VAR_FPPAR), fp_par)</div>
<div class="line">    _insertRecord(new VarKey(XType.Int, XM.VAR_FSIZE), FS.LENGTH_HEADER)</div>
<div class="line">    return fp</div>
<div class="line">end </div>
<div class="line"> </div>
<div class="line">#フレームにおいて，指定した変数キーをもつ最初のレコードを見つける</div>
<div class="line">def VarRecord FS.lookupVarRecordRef(Int fp, VarKey var) do </div>
<div class="line">    Int flen = FS.getIntVal(fp+FS.OFFSET_FSIZE); </div>
<div class="line">    for (Int p = fp + FS.LENGTH_HEADER; p &lt; fp + flen; p++) {</div>
<div class="line">        VarRecord r = FS.get(p) </div>
<div class="line">        if (r.var.typ == var.typ and r.var.vid == var.vid) </div>
<div class="line">            return r</div>
<div class="line">    }</div>
<div class="line">    return null</div>
<div class="line">end </div>
<div class="line"> </div>
<div class="line">#変数キーから対応する最近変数の変数参照（レコードの番地）を得る</div>
<div class="line">def Int FS.fetchVarRecordRef(Int fp, VarKey var) do </div>
<div class="line">    while (fp != UNDEF) do</div>
<div class="line">        Int p = FS.lookupVarRecordRef(fp, var)</div>
<div class="line">        if (p != UNDEF) do </div>
<div class="line">            return p </div>
<div class="line">        else </div>
<div class="line">            fp = FS.getIntVal(fp+FS.OFFSET_FPPAR)   #never failed</div>
<div class="line">        end </div>
<div class="line">    end </div>
<div class="line">    panic(&quot;variable not defined! &quot;+var)</div>
<div class="line">end</div>
</div><!-- fragment --><h2>フレームスタックの公開関数</h2>
<div class="fragment"><div class="line">#新しいフレームを生成する</div>
<div class="line">def Int FS.allocFrame(Int fp_par) do</div>
<div class="line">    return FS._alloc_frame_(Int fp_par)</div>
<div class="line">end </div>
<div class="line"> </div>
<div class="line">#新しいレコードを挿入し，フレーム情報を更新する</div>
<div class="line">def Int FS.insertRecord(Int fp, VarKey var, Object val) do </div>
<div class="line">    #新しい空レコードを挿入する</div>
<div class="line">    Int p = FS._insertRecord(var, val)</div>
<div class="line">    </div>
<div class="line">    #フレームの長さレコードの値を1増加させる</div>
<div class="line">    VarRecord rz = FS.get(fp+FS.OFFSET_FSIZE)</div>
<div class="line">    assert rz.var.vid == XM.VAR_FSIZE </div>
<div class="line">    assert rz.var.typ == XType.Int</div>
<div class="line">    assert rz.val instanceof Int</div>
<div class="line">    rz.val = rz.val + 1 #値を1つ増加</div>
<div class="line">    return fp</div>
<div class="line">end </div>
<div class="line"> </div>
<div class="line">#変数キーから変数参照を得る</div>
<div class="line">def Object FS.getVarRef(Int fp, VarKey var) do </div>
<div class="line">    Int p = FS.fetchVarRecordRef(fp, var)</div>
<div class="line">    return p </div>
<div class="line">end</div>
<div class="line"> </div>
<div class="line">#変数キーから各種の値を得る</div>
<div class="line">def Object FS.getVarVal(Int fp, VarKey var) do </div>
<div class="line">    Int p = FS.fetchVarRecordRef(fp, var)</div>
<div class="line">    VarRecord r = FS.get(p) </div>
<div class="line">    return r.val</div>
<div class="line">end</div>
</div><!-- fragment --><h2>ブロックのプロセス呼び出し</h2>
<p>次のコードは，与えられたブロックをプロセスとして，XMachineに呼び出させる．プロセスは，返番地と入力値を保持し，実行待ち状態になる．</p>
<div class="fragment"><div class="line">#ブロックをプロセスとして呼び出す．</div>
<div class="line">def XM.spawnProcess(BlockDef bdef, Int fp_par, List&lt;VarKey&gt; rets, List&lt;VarKey&gt; args) do </div>
<div class="line">    Int fp = allocFrame(fp_par)</div>
<div class="line">    for var in bdef.nrets do </div>
<div class="line">        insertRecord(fp, var, FS.getVarRef(fp_par, var)) </div>
<div class="line">    end </div>
<div class="line">    for var in bdef.nargs do </div>
<div class="line">        insertRecord(fp, var, FS.getVarVal(fp_par, var)) </div>
<div class="line">    end </div>
<div class="line">    for var in bdef.nvars do </div>
<div class="line">        insertRecord(fp, var, null) </div>
<div class="line">    end </div>
<div class="line">end</div>
<div class="line"> </div>
<div class="line">#XMの実行コード. Given fp_par </div>
<div class="line">rets_ = [ ref(r1), ..., ref(rk) ]</div>
<div class="line">args_ = [ val(a1), ..., val(am) ]</div>
<div class="line">Int fp = spawnProcess(blockdef, fp_par, rets_, args_)</div>
</div><!-- fragment --><h2>ブロックのプロセス実行</h2>
<p>次のコードは，ブロックの実行待ち状態になっているプロセスを，XMachineに実行させる．返番地と引数はすでに与えられている．</p>
<div class="fragment"><div class="line">#ブロックの実行待ち状態になっているプロセスを実行する．返番地と引数はすでに与えられている．</div>
<div class="line">def XM.invokeProcess(blockdef, fp) do </div>
<div class="line">    OVM.execCode(blockdef.code, fp)</div>
<div class="line">end </div>
<div class="line"> </div>
<div class="line">#XMの実行コード</div>
<div class="line">invokeProcess(blockdef, fp)</div>
</div><!-- fragment --><h2>関数呼び出し</h2>
<p>次の無名関数呼び出しを考える． </p><div class="fragment"><div class="line">#Given fp_par</div>
<div class="line">rets = { function (args) body } (values)</div>
<div class="line">=&gt; </div>
<div class="line">blockdef = function (args) body</div>
<div class="line">Int fp = spawnProcess(blockdef, fp_par)</div>
</div><!-- fragment --><p>このとき，実行したい関数のブロック構造体から</p>
<hr  />
 <h1>ブロック処理の例： for文のコンパイル</h1>
<p>for文を考える．</p>
<div class="fragment"><div class="line">for (int i = 0; i &lt; m; i++) </div>
<div class="line">do </div>
<div class="line">    ... </div>
<div class="line">end</div>
</div><!-- fragment --><p>これは，次のように考える．</p>
<div class="fragment"><div class="line">do </div>
<div class="line">    int i</div>
<div class="line">    for (i = 0; i &lt; m; i++) </div>
<div class="line">        task</div>
<div class="line">end</div>
</div><!-- fragment --><p>コンパイルすると次になる</p>
<div class="fragment"><div class="line">block</div>
<div class="line">    varlist: [ (vid(&#39;i&#39;), XType.Integer) ]</div>
<div class="line">    nrets: 0</div>
<div class="line">    nargs: 0</div>
<div class="line">    nvars: 1</div>
<div class="line">    codes: code</div>
<div class="line">        fp = FS.pushFrame()</div>
<div class="line">        OVM.pushLevel(fp)</div>
<div class="line">        int i</div>
<div class="line">        i = 0</div>
<div class="line">        ifstart:</div>
<div class="line">        put (i &lt; m)</div>
<div class="line">        if top is false then goto iffalse: </div>
<div class="line">        code of task </div>
<div class="line">        i++</div>
<div class="line">        goto ifstart</div>
<div class="line">        iffalse:</div>
<div class="line">        OVM.popLevel()</div>
<div class="line">        FS.popFrame()</div>
<div class="line">    end </div>
<div class="line">end </div>
</div><!-- fragment --><hr  />
 <h1>簡略記法: オプション-iを用いたワンライナー</h1>
<p>from節を用いたクエリ</p>
<div class="fragment"><div class="line">xscan -e &#39;from open(&quot;../data/dblp1K.xml&quot;) go dblp/(article|inproceedings) [ true ] return &quot;{{ title }}&quot; &#39; </div>
</div><!-- fragment --><p>を次のようにかけるようにする．</p>
<div class="fragment"><div class="line">xscan -e &#39;dblp/(article|inproceedings) [ true ] return &quot;{{ title }}&quot; &#39; -i ../data/dblp1K.xml </div>
</div><!-- fragment --><hr  />
 <h1>クエリ実行機構</h1>
<p>ブロック構文と変数束縛によって理解する。 次のプログラムを考える：</p>
<div class="fragment"><div class="line">from open(&quot;../data/dblp1K.xml&quot;) </div>
<div class="line">    do query end </div>
</div><!-- fragment --><p>これは，次のように展開される:</p>
<div class="fragment"><div class="line">var ins = sys.stdin, os = sys.stdout </div>
<div class="line">do </div>
<div class="line">    ins = open(&quot;../data/dblp1K.xml&quot;) </div>
<div class="line">    scan ins query.main</div>
<div class="line">        do |event| </div>
<div class="line">            exec(event)</div>
<div class="line">        end </div>
<div class="line">end</div>
</div><!-- fragment --><p>ここで，scan 命令は次のように定義される:</p>
<div class="fragment"><div class="line">def scan(func) block do</div>
<div class="line">    global ins #外部で定義</div>
<div class="line">    for event in ins </div>
<div class="line">    do</div>
<div class="line">        block |event| </div>
<div class="line">    end </div>
<div class="line">end </div>
</div><!-- fragment --><hr  />
 <h2>EOF</h2>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu May 6 2021 01:30:56 for asax02.neo by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
